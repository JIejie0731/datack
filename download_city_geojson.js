const fs = require('fs');
const https = require('https');
const path = require('path');

// 这里填你需要的地市行政区划代码
const cityCodes = [
    // 北京市
    '110100',
    // 天津市
    '120100',
    // 河北省
    '130100','130200','130300','130400','130500','130600','130700','130800','130900','131000','131100',
    // 山西省
    '140100','140200','140300','140400','140500','140600','140700','140800','140900','141000','141100',
    // 内蒙古自治区
    '150100','150200','150300','150400','150500','150600','150700','150800','150900',
    // 辽宁省
    '210100','210200','210300','210400','210500','210600','210700','210800','210900','211000','211100','211200','211300','211400',
    // 吉林省
    '220100','220200','220300','220400','220500','220600','220700','220800','222400',
    // 黑龙江省
    '230100','230200','230300','230400','230500','230600','230700','230800','230900','231000','231100','231200','232700',
    // 上海市
    '310100',
    // 江苏省
    '320100','320200','320300','320400','320500','320600','320700','320800','320900','321000','321100','321200','321300',
    // 浙江省
    '330100','330200','330300','330400','330500','330600','330700','330800','330900','331000','331100',
    // 安徽省
    '340100','340200','340300','340400','340500','340600','340700','340800','341000','341100','341200','341300','341500','341600','341700','341800','342200',
    // 福建省
    '350100','350200','350300','350400','350500','350600','350700','350800','350900',
    // 江西省
    '360100','360200','360300','360400','360500','360600','360700','360800','360900','361000','361100',
    // 山东省
    '370100','370200','370300','370400','370500','370600','370700','370800','370900','371000','371100','371200','371300','371400','371500','371600','371700',
    // 河南省
    '410100','410200','410300','410400','410500','410600','410700','410800','410900','411000','411100','411200','411300','411400','411500','411600','411700','419000',
    // 湖北省
    '420100','420200','420300','420500','420600','420700','420800','420900','421000','421100','421200','421300','422800','429000',
    // 湖南省
    '430100','430200','430300','430400','430500','430600','430700','430800','430900','431000','431100','431200','431300','433100',
    // 广东省
    '440100','440200','440300','440400','440500','440600','440700','440800','440900','441200','441300','441400','441500','441600','441700','441800','441900','442000','445100','445200','445300','460100','460200','460300','469000',
    // 广西壮族自治区
    '450100','450200','450300','450400','450500','450600','450700','450800','450900','451000','451100','451200','451300','451400',
    // 海南省
    '460100','460200','460300','469000',
    // 重庆市
    '500100','500200',
    // 四川省
    '510100','510300','510400','510500','510600','510700','510800','510900','511000','511100','511300','511400','511500','511600','511700','511800','511900','512000','513200','513300','513400',
    // 贵州省
    '520100','520200','520300','520400','520500','520600','522300','522600','522700',
    // 云南省
    '530100','530300','530400','530500','530600','530700','530800','530900','532300','532500','532600','532800','532900','533100','533300','533400','533500',
    // 西藏自治区
    '540100','540200','540300','540400','540500','540600','542500',
    // 陕西省
    '610100','610200','610300','610400','610500','610600','610700','610800','610900','611000',
    // 甘肃省
    '620100','620200','620300','620400','620500','620600','620700','620800','620900','621000','621100','621200','622900','623000',
    // 青海省
    '630100','630200','632200','632300','632500','632600','632700','632800',
    // 宁夏回族自治区
    '640100','640200','640300','640400','640500',
    // 新疆维吾尔自治区
    '650100','650200','650400','650500','652300','652700','652800','652900','653000','653100','653200','654000','654200','654300','659000',
    // 香港特别行政区
    '810000',
    // 澳门特别行政区
    '820000',
    // 台湾省（仅供参考，实际下钻一般不做地市）
    '710100','710200','710300','710400','710500','710600','710700'
  ];

const saveDir = path.join(__dirname, 'frontend/public/city');
if (!fs.existsSync(saveDir)) fs.mkdirSync(saveDir, { recursive: true });

const download = (url, dest) => new Promise((resolve, reject) => {
  https.get(url, res => {
    if (res.statusCode !== 200) return reject(res.statusCode);
    const file = fs.createWriteStream(dest);
    res.pipe(file);
    file.on('finish', () => file.close(resolve));
  }).on('error', reject);
});

(async () => {
  for (const code of cityCodes) {
    const url = `https://geo.datav.aliyun.com/areas_v3/bound/geojson?code=${code}_full`;
    const dest = path.join(saveDir, `${code}.json`);
    console.log(`下载 ${code} -> ${dest}`);
    try {
      await download(url, dest);
      console.log(`完成: ${code}`);
    } catch (e) {
      console.error(`失败: ${code}`, e);
    }
  }
})();